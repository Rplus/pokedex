<script>
  import { pokemons } from '@/stores.js';
  import { cdnImgSrc, ASSET_FOLDER } from '@/u.js';
  export let data;

  $: {
    data.pm = getPm(data.name);
    data.src = cdnImgSrc(pmImgFN(`000${data.pm.dex}`.slice(-3), data.iso));
  }

  let candySrc = cdnImgSrc(`${ASSET_FOLDER}static_assets/png/pokemon_details_candy.png`, 32);

  function getPm(pid) {
    if (!$pokemons.length) {
      return false;
    }
    return $pokemons.find(pm => pm.id === pid);
  }

  function pmImgFN(dex3, iso = '00') {
    return `${ASSET_FOLDER}/pokemon_icons/pokemon_icon_${dex3}_${iso}.png`;
  }
</script>



<div class="family-tree df jc-c ai-c text-center fz-s">
  <a class="pm df fd-c text-no-decoration"
    title="#{data.pm.dex} {data.pm.name}"
    href="./pokemon/{data.pm.uid}"
  >
    <div class="pm-img mb-1"
      data-id="{data.pm.uid}"
      data-dex="#{data.pm.dex}"
      style="background-image: url({data.src}); --bdw: var(--uid-bdw-{data.pm.uid}, 0px);"
    />
    {@html data.pm.name.replace(' ', '<br>')}
  </a>


  {#if data.next}
    <div class="family-next df fd-c">

      {#each data.next as item}
        <div class="df">
          <div class="evolve-requirement df fd-c jc-c">

            <div class="d-if ai-c">
              {item.candyCost}
              <img class="candy" src={candySrc} alt="candy">
            </div>

            <div>➡</div>

            {#if item.requirement}
              <div class="rs">
                <details>
                  <summary dir="ltr">條件</summary>
                  <ul class="rs-list pos-a m-0 text-left">
                    {#each item.requirement as ri}
                      <li>{ri}</li>
                    {/each}
                  </ul>
                </details>
              </div>
            {/if}

          </div>

          <svelte:self data={item} />
        </div>
      {/each}

    </div>
  {/if}
</div>


<style>
  .family-tree {
    --unit: 72px;
  }

  .family-tree :global(.family-tree) {
    margin-top: .5em;
    margin-left: 1em;
    margin-bottom: .5em;
    padding-left: 1em;
  }

  .family-next {
    margin-left: 1em;
  }

  .pm {
    color: inherit;
  }

  .pm-img {
    position: relative;
    width: var(--unit);
    height: var(--unit);
    background-size: cover;
    box-shadow: 0 0 1px var(--bdw) #aaa;
  }
  .pm-img::before {
    position: absolute;
    top: .1em;
    left: .25em;
    content: attr(data-dex);
    font-size: smaller;
    color: #aaa;
  }

  .candy {
    width: 12px;
    height: 12px;
  }

  .rs summary {
    color: #999;
  }

  .rs-list {
    padding: .25em 1.5em;
    background-color: #cff;
    box-shadow: inset 0 0 1px;
    z-index: 1;
  }
</style>
